<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Elevator by oleiade</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Elevator</h1>
          <h2>Minimalistic database engine based on levelDB as a backend, and protocol buffer as a message protocol.</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/oleiade/Elevator/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/oleiade/Elevator/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/oleiade/Elevator" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>Elevator</h1>

<p>Minimalistic key/value store powered by levelDB and written in Python.
Allows async, remote acces to a multithreaded leveldb backend. Handles multiple database access and storage. Elevator tries to sublimate leveldb amazing features (disk persistent fast writes/reads, batching system, [...]) by plugging it into a transparent rpc-like service.</p>

<p>Relies on the zeromq network library and msgpack serialization format, it is made to be portable between languages and platforms. See <em>message system</em></p>

<h2>Dependencies</h2>

<div class="highlight"><pre>pyzmq
leveldb
snappy
py-leveldb
</pre></div>

<h2>Installation</h2>

<div class="highlight"><pre>pip install fabric
fab build
python setup.py install
</pre></div>

<h2>Server</h2>

<h3>Usage</h3>

<p>When elevator is installed, you can then launch the server using the elevator executable. Note that a --daemon option is disposable, and allows you to run elevator server as a daemon, storing it's pid in .pid file in /tmp.</p>

<p>See config/elevator.conf for an example of Elevator configuration.</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre>elevator --help
usage: elevator <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>--daemon<span class="o">]</span> <span class="o">[</span>--config CONFIG<span class="o">]</span> <span class="o">[</span>--bind BIND<span class="o">]</span> <span class="o">[</span>--port PORT<span class="o">]</span>
                <span class="o">[</span>--db DB<span class="o">]</span>

Elevator <span class="nb">command </span>line manager

optional arguments:
  -h, --help       show this <span class="nb">help </span>message and <span class="nb">exit</span>
  --daemon
  --config CONFIG
  --bind BIND
  --port PORT
  --db DB
</pre></div>

<h3>Configuration</h3>

<p>Server configuration relies on a INI file you can pass it as --config argument. All the configuration options key/value are then loaded in a server specific singleton Environment object, which any part of the server can eventually access.</p>

<p><strong>example config</strong> (<em>config/elevator.conf</em>)</p>

<div class="highlight"><pre><span class="k">[global]</span>
<span class="c"># By default Elevator does not run as a daemon. Use 'yes' if you need it.</span>
<span class="c"># Note that Elevator will write a pid file in /var/run/elevator.pid when daemonized.</span>
<span class="na">daemonize</span> <span class="o">=</span> <span class="s">no</span>

<span class="c"># When running daemonized, Elevator writes a pid file in /var/run/elevator.pid by</span>
<span class="c"># default. You can specify a custom pid file location here.</span>
<span class="na">pidfile</span> <span class="o">=</span> <span class="s">/var/run/elevator.pid</span>

<span class="c"># Where databases files should be store on the filesystem.</span>
<span class="na">database_store</span> <span class="o">=</span> <span class="s">/var/lib/elevator</span>

<span class="c">#Default database</span>
<span class="na">default_db</span> <span class="o">=</span> <span class="s">default</span>

<span class="c"># Accept connections on the specified port, default is 4141.</span>
<span class="c"># If port 0 is specified Elevator will not listen on a TCP socket.</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">4141</span>

<span class="c"># If you want you can bind a single interface, if the bind option is not</span>
<span class="c"># specified all the interfaces will listen for incoming connections.</span>
<span class="c">#</span>
<span class="na">bind</span> <span class="o">=</span> <span class="s">127.0.0.1</span>

<span class="c"># Specify the path for the unix socket that will be used to listen for</span>
<span class="c"># incoming connections. There is no default, so Elevator will not listen</span>
<span class="c"># on a unix socket when not specified.</span>
<span class="c">#</span>
<span class="c"># unixsocket = /tmp/elevator.sock</span>
</pre></div>

<h3>Messages</h3>

<p>Typically, Server and client communicates via a tcp:// socket handled by zeromq network library. Server spawns worker (threads) which it communicates with using an inproc:// method. Every messages passed between client and server, or server and it's workers are serialized using msgpack.</p>

<p><strong>NOTA</strong> as Elevator uses XREP and XREQ sockets, every commands passed through sockets are signed with a client id prefixing every sent datas.</p>

<h4>Client/Server message format (Request)</h4>

<div class="highlight"><pre><span class="p">[</span>
    <span class="err">database_uid:</span> <span class="s2">"Md5 hash : of the database name you're working on"</span>
    <span class="err">command_code:</span> <span class="s2">"String : PUT or GET"</span>
    <span class="err">command_args:</span> <span class="s2">"List : command arguments list"</span>
<span class="p">]</span>
</pre></div>

<h4>Server/Client message format (Response)</h4>

<p><strong>If the command succeeded</strong></p>

<div class="highlight"><pre><span class="p">[</span>
    <span class="err">response_status:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="err">resulting_datas:</span> <span class="s2">""</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

<p><strong>If the command failed</strong></p>

<div class="highlight"><pre><span class="p">[</span>
    <span class="err">response_status:</span> <span class="mi">-1</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="err">error_code:</span> <span class="err">Int</span><span class="p">,</span>
        <span class="err">error_message:</span> <span class="s2">"error message"</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">]</span>
</pre></div>

<h3>Constants</h3>

<h4>Error types codes</h4>

<p>All defined in elevator/constants.py module, they're used to bind an Elevator error type (python) to a language exception type.</p>

<div class="highlight"><pre><span class="n">TYPE_ERROR</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">KEY_ERROR</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">VALUE_ERROR</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">INDEX_ERROR</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">RUNTIME_ERROR</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>

<p><em>Here's how the integrated python client deals with error codes</em></p>

<div class="highlight"><pre><span class="c"># error.py</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">elevator.constants</span> <span class="kn">import</span> <span class="o">*</span>


<span class="n">ELEVATOR_ERROR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">TYPE_ERROR</span><span class="p">:</span> <span class="ne">TypeError</span><span class="p">,</span>
    <span class="n">KEY_ERROR</span><span class="p">:</span> <span class="ne">KeyError</span><span class="p">,</span>
    <span class="n">VALUE_ERROR</span><span class="p">:</span> <span class="ne">ValueError</span><span class="p">,</span>
    <span class="n">INDEX_ERROR</span><span class="p">:</span> <span class="ne">IndexError</span><span class="p">,</span>
    <span class="n">RUNTIME_ERROR</span><span class="p">:</span> <span class="ne">RuntimeError</span><span class="p">,</span>
<span class="p">}</span>

<span class="c"># base.py</span>
<span class="kn">from</span> <span class="nn">.error</span> <span class="kn">import</span> <span class="n">ELEVATOR_ERROR</span>

<span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_uid</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">datas</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">Message</span><span class="p">(</span><span class="n">db_uid</span><span class="o">=</span><span class="n">db_uid</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">datas</span><span class="p">)])</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">FAILURE_STATUS</span><span class="p">:</span>
            <span class="n">error_code</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">raise</span> <span class="n">ELEVATOR_ERROR</span><span class="p">[</span><span class="n">error_code</span><span class="p">](</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">content</span>
</pre></div>

<h4>Response status</h4>

<p>Server responses ships with a status code to indicate whether the command was correctly executed or failed.
Here's their definition.</p>

<div class="highlight"><pre><span class="c"># Status codes</span>
<span class="n">SUCCESS_STATUS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">FAILURE_STATUS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>

<h3>Client</h3>

<p>In order to communicate with elevator, a Python client is avalaible. You can use it through the Elevator object, brought by the client module.</p>

<p>Note that by default, client to 'default' database. As Elevator implements a multi-db system, you can create/list/delete/repair databases. To connect to another database, use the eponyme function .connect()</p>

<p><strong>Here is a demo:</strong></p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">elevator.client</span> <span class="kn">import</span> <span class="n">Elevator</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">E</span> <span class="o">=</span> <span class="n">Elevator</span><span class="p">()</span>  <span class="c"># N.B : connected to 'default'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Ebis</span> <span class="o">=</span> <span class="n">Elevator</span><span class="p">(</span><span class="s">'testdb'</span><span class="p">)</span>  <span class="c"># You can even construct your client with desired db to connect to</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">E</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'testdbbis'</span><span class="p">)</span>  <span class="c"># Or even rebind client to a new database</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">E</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="s">'abc'</span><span class="p">,</span> <span class="s">'cba'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">E</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">'abc'</span><span class="p">)</span>
<span class="s">'cba'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">E</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="s">'abc'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">E</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">E</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="s">'1'</span><span class="p">,</span> <span class="s">'9'</span><span class="p">)</span>
<span class="p">[[</span><span class="s">'1'</span><span class="p">,</span><span class="s">'1'</span><span class="p">],</span>
 <span class="p">[</span><span class="s">'2'</span><span class="p">,</span><span class="s">'2'</span><span class="p">],</span>
 <span class="p">[</span><span class="s">'3'</span><span class="p">,</span> <span class="s">'3'</span><span class="p">],</span>
 <span class="p">[</span><span class="s">'4'</span><span class="p">,</span> <span class="s">'4'</span><span class="p">],</span>
 <span class="p">[</span><span class="s">'5'</span><span class="p">,</span> <span class="s">'5'</span><span class="p">],</span>
 <span class="p">[</span><span class="s">'6'</span><span class="p">,</span> <span class="s">'6'</span><span class="p">],</span>
 <span class="p">[</span><span class="s">'7'</span><span class="p">,</span> <span class="s">'7'</span><span class="p">],</span>
 <span class="p">[</span><span class="s">'8'</span><span class="p">,</span> <span class="s">'8'</span><span class="p">],</span>
 <span class="p">[</span><span class="s">'9'</span><span class="p">,</span> <span class="s">'9'</span><span class="p">],</span>
<span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">E</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="s">'1'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">[[</span><span class="s">'1'</span><span class="p">,</span> <span class="s">'1'</span><span class="p">],</span>
 <span class="p">[</span><span class="s">'2'</span><span class="p">,</span> <span class="s">'2'</span><span class="p">],</span>
<span class="p">]</span>
</pre></div>

<p>Batches are implemented too. They're very handy and very fast when it comes to write a lot of datas to the database. See LevelDB documentation for more informations. Use it through the WriteBatch client module class. It has three base methods modeled on LevelDB's Put, Delete, Write.</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">elevator.client</span> <span class="kn">import</span> <span class="n">WriteBatch</span><span class="p">,</span> <span class="n">Elevator</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span> <span class="o">=</span> <span class="n">WriteBatch</span><span class="p">()</span>  <span class="c"># N.B : port, host, and timeout options are available here</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="s">'a'</span><span class="p">,</span> <span class="s">'a'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="s">'b'</span><span class="p">,</span> <span class="s">'b'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="s">'c'</span><span class="p">,</span> <span class="s">'c'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="s">'c'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">E</span> <span class="o">=</span> <span class="n">Elevator</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">E</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">'a'</span><span class="p">)</span>
<span class="s">'a'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">E</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">'b'</span><span class="p">)</span>
<span class="s">'b'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">E</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">'c'</span><span class="p">)</span>
<span class="ne">KeyError</span><span class="p">:</span> <span class="s">"Key not found"</span>
</pre></div>

<h3>Thanks</h3>

<p>Thanks to srinikom for its leveldb-server which was a very good base to start from. Thanks to Google, for its amazing database. Thanks to ZeroMQ team, you changed my life!</p>
        </section>

        <footer>
          Elevator is maintained by <a href="https://github.com/oleiade">oleiade</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>