<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Elevator by oleiade</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/oleiade/Elevator">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/oleiade/Elevator/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/oleiade/Elevator/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Elevator</h1>
          <p>Minimalistic database engine based on levelDB as a backend, and protocol buffer as a message protocol.</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/oleiade">oleiade</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></span>
        </div>

        <h1>Elevator</h1>

<h2>About</h2>

<p>Minimalistic key/value store powered by levelDB and written in Python.
Allows async, remote acces to a multithreaded leveldb backend. Handles multiple database access and storage. Elevator tries to sublimate leveldb amazing features (disk persistent fast writes/reads, batching system, [...]) by plugging it into a transparent rpc-like service.</p>

<p>Relies on the zeromq network library and msgpack serialization format, it is made to be portable between languages and platforms. See <em>message system</em></p>

<h2>Dependencies</h2>

<div class="highlight"><pre>pyzmq
leveldb
snappy
py-leveldb
</pre></div>

<h2>Installation</h2>

<div class="highlight"><pre>pip install fabric
fab build
python setup.py install
</pre></div>

<h2>Server</h2>

<h3>Usage</h3>

<p>When elevator is installed, you can then launch the server using the elevator executable. Note that a --daemon option is disposable, and allows you to run elevator server as a daemon, storing it's pid in .pid file in /tmp.</p>

<p>See config/elevator.conf for an example of Elevator configuration.</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre>elevator --help
usage: elevator <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>--daemon<span class="o">]</span> <span class="o">[</span>--config CONFIG<span class="o">]</span> <span class="o">[</span>--bind BIND<span class="o">]</span> <span class="o">[</span>--port PORT<span class="o">]</span> <span class="o">[</span>--workers WORKERS COUNT<span class="o">]</span>

Elevator <span class="nb">command </span>line manager

optional arguments:
  -h, --help       show this <span class="nb">help </span>message and <span class="nb">exit</span>
  --daemon
  --config      Path to elevator server config file, eventually
  --bind        Ip to <span class="nb">bind </span>server to
  --port        Port the server should listen on
  --workers     How many workers should be spawned?
</pre></div>

<h3>Configuration</h3>

<p>Server configuration relies on a INI file you can pass it as --config argument. All the configuration options key/value are then loaded in a server specific singleton Environment object, which any part of the server can eventually access.</p>

<p><strong>example config</strong> (<em>config/elevator.conf</em>)</p>

<div class="highlight"><pre><span class="k">[global]</span>
<span class="c"># By default Elevator does not run as a daemon. Use 'yes' if you need it.</span>
<span class="c"># Note that Elevator will write a pid file in /var/run/elevator.pid when daemonized.</span>
<span class="na">daemonize</span> <span class="o">=</span> <span class="s">no</span>

<span class="c"># When running daemonized, Elevator writes a pid file in /var/run/elevator.pid by</span>
<span class="c"># default. You can specify a custom pid file location here.</span>
<span class="na">pidfile</span> <span class="o">=</span> <span class="s">/var/run/elevator.pid</span>

<span class="c"># Where databases files should be store on the filesystem.</span>
<span class="na">database_store</span> <span class="o">=</span> <span class="s">/var/lib/elevator</span>

<span class="c">#Default database</span>
<span class="na">default_db</span> <span class="o">=</span> <span class="s">default</span>

<span class="c"># Accept connections on the specified port, default is 4141.</span>
<span class="c"># If port 0 is specified Elevator will not listen on a TCP socket.</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">4141</span>

<span class="c"># If you want you can bind a single interface, if the bind option is not</span>
<span class="c"># specified all the interfaces will listen for incoming connections.</span>
<span class="c">#</span>
<span class="na">bind</span> <span class="o">=</span> <span class="s">127.0.0.1</span>

<span class="c"># Path to file were server activity should be logged</span>
<span class="na">activity_log</span> <span class="o">=</span> <span class="s">/var/log/elevator.log</span>

<span class="c"># Path to file were server warnings, errors, exceptions should be logged</span>
<span class="na">errors_log</span> <span class="o">=</span> <span class="s">/var/log/elevator_errors.log</span>

<span class="c"># Specify the path for the unix socket that will be used to listen for</span>
<span class="c"># incoming connections. There is no default, so Elevator will not listen</span>
<span class="c"># on a unix socket when not specified.</span>
<span class="c">#</span>
<span class="c"># unixsocket = /tmp/elevator.sock</span>
</pre></div>

<h3>Messages</h3>

<p>Typically, Server and client communicates via a tcp:// socket handled by zeromq network library. Server spawns worker (threads) which it communicates with using an inproc:// method. Every messages passed between client and server, or server and it's workers are serialized using msgpack.</p>

<p><strong>NOTA</strong> as Elevator uses XREP and XREQ sockets, every commands passed through sockets are signed with a client id prefixing every sent datas.</p>

<h4>Client/Server message format (Request)</h4>

<div class="highlight"><pre><span class="p">[</span>
    <span class="s2">"database_uid"</span> <span class="err">:</span> <span class="s2">"Md5 hash : of the database name you're working on"</span>
    <span class="s2">"command_code"</span> <span class="err">:</span> <span class="s2">"String : PUT or GET"</span>
    <span class="s2">"command_args"</span> <span class="err">:</span> <span class="s2">"List : command arguments list"</span>
<span class="p">]</span>
</pre></div>

<h4>Server/Client message format (Response)</h4>

<p><strong>If the command succeeded</strong></p>

<div class="highlight"><pre><span class="p">[</span>
    <span class="s2">"response_status"</span> <span class="err">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"resulting_datas"</span> <span class="err">:</span> <span class="s2">""</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

<p><strong>If the command failed</strong></p>

<div class="highlight"><pre><span class="p">[</span>
    <span class="s2">"response_status"</span> <span class="err">:</span> <span class="mi">-1</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="s2">"error_code"</span> <span class="err">:</span> <span class="err">ERROR_CODE</span><span class="p">,</span>
        <span class="s2">"error_message"</span> <span class="err">:</span> <span class="s2">"error message"</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">]</span>
</pre></div>

<h4>Example</h4>

<p><strong>Request</strong></p>

<p>Requesting to put 'key'/'value' pair.</p>

<div class="highlight"><pre><span class="p">[</span><span class="s2">"theamazingdatabasewewannaupdatemd5hash"</span><span class="p">,</span> <span class="s2">"PUT"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"key"</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">]]</span>
</pre></div>

<p><em>would return</em></p>

<p><strong>Successful (and proud) Response</strong></p>

<p>Value has been succesfully added, server responds everything went fine with the SUCCESS_STATUS, and null as return value.</p>

<div class="highlight"><pre><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kc">null</span><span class="p">]</span>
</pre></div>

<p><strong>Failure (and sheepish)</strong></p>

<p>Let's say you tried to put an int into Elevator (which he can't as it only handles strings). Note that ERROR_CODE value is 2, which represents a VALUE_ERROR, see <strong>Error types codes</strong></p>

<div class="highlight"><pre><span class="p">[</span><span class="mi">-1</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"Invalid value type supplied"</span><span class="p">]]</span>
</pre></div>

<h3>Constants</h3>

<h4>Commands</h4>

<p>Server responds to some constants whenever it comes to give it commands. In the following listing, dbuid represents the database unique uid to operate the command over, it can be retrieved from a database name via 'CONNECT'. And batch_uid represents a valid server-side created batch (using BCREATE) to run commands over.</p>

<div class="highlight"><pre><span class="s">'GET'</span><span class="p">,</span> <span class="p">[</span><span class="n">dbuid</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span>  <span class="c"># Get a value from a db</span>
<span class="s">'PUT'</span><span class="p">,</span> <span class="p">[</span><span class="n">dbuid</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>  <span class="c"># Insert a value in a db</span>
<span class="s">'DELETE'</span><span class="p">,</span> <span class="p">[</span><span class="n">dbuid</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span>  <span class="c"># Delete a value from a db</span>
<span class="s">'RANGE'</span><span class="p">,</span> <span class="p">[</span><span class="n">dbuid</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">limit</span><span class="p">]</span>  <span class="c"># Retrieve a range of key/value pair from a db</span>
<span class="s">'BPUT'</span><span class="p">,</span> <span class="p">[</span><span class="n">batch_uid</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>  <span class="c"># Inserts a value in a server-side batch</span>
<span class="s">'BDELETE'</span><span class="p">,</span> <span class="p">[</span><span class="n">batch_uid</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span>  <span class="c"># Deletes a value from a server-side batch </span>
<span class="s">'BWRITE'</span><span class="p">,</span> <span class="p">[</span><span class="n">batch_uid</span><span class="p">]</span>  <span class="c"># Apply all batch operations server-side</span>
<span class="s">'BCLEAR'</span><span class="p">,</span> <span class="p">[</span><span class="n">batch_uid</span><span class="p">]</span>  <span class="c"># Empty a server-side batch</span>
<span class="s">'DBCONNECT'</span><span class="p">,</span> <span class="p">[</span><span class="n">db_name</span><span class="p">]</span>  <span class="c"># Connects a db via retrieving it's server-side uid</span>
<span class="s">'DBCREATE'</span><span class="p">,</span> <span class="p">[</span><span class="n">db_name</span><span class="p">,</span> <span class="n">db_options</span><span class="p">]</span>  <span class="c"># Creates a db, with db_options</span>
<span class="s">'DBLIST'</span><span class="p">,</span> <span class="p">[]</span>  <span class="c"># Lists all server's dbs</span>
<span class="s">'DBREPAIR'</span><span class="p">,</span> <span class="p">[</span><span class="n">dbuid</span><span class="p">]</span>  <span class="c"># Repairs a broken (or too slow) database</span>
</pre></div>

<p><strong>About db creation options</strong>: Leveldb offers nice options when it comes to configure the backend storage and caching behavior. They should be passed in the msgpack message supplied to server on db creation as a hash. Only values set by yourself will override default values. Here is a description offered by py-leveldb of the available options.</p>

<div class="highlight"><pre><span class="n">create_if_missing</span>  <span class="c">#(default: True)           if True, creates a new database if none exists</span>
<span class="n">error_if_exists</span>    <span class="c">#(default: False)          if True, raises and error if the database already exists</span>
<span class="n">paranoid_checks</span>    <span class="c">#(default: False)          if True, raises an error as soon as an internal corruption is detected</span>
<span class="n">block_cache_size</span>   <span class="c">#(default: 8 * (2 &lt;&lt; 20))  maximum allowed size for the block cache in bytes</span>
<span class="n">write_buffer_size</span>  <span class="c">#(default  2 * (2 &lt;&lt; 20))  </span>
<span class="n">block_size</span>         <span class="c">#(default: 4096)           unit of transfer for the block cache in bytes</span>
<span class="n">max_open_files</span><span class="p">:</span>    <span class="c">#(default: 1000)</span>
</pre></div>

<h4>Error types codes</h4>

<p>All defined in elevator/constants.py module, they're used to bind an Elevator error type (python) to a language exception type.</p>

<div class="highlight"><pre><span class="n">TYPE_ERROR</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">KEY_ERROR</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">VALUE_ERROR</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">INDEX_ERROR</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">RUNTIME_ERROR</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>

<p><em>Here's how the integrated python client deals with error codes</em></p>

<div class="highlight"><pre><span class="c"># error.py</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">elevator.constants</span> <span class="kn">import</span> <span class="o">*</span>


<span class="n">ELEVATOR_ERROR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">TYPE_ERROR</span><span class="p">:</span> <span class="ne">TypeError</span><span class="p">,</span>
    <span class="n">KEY_ERROR</span><span class="p">:</span> <span class="ne">KeyError</span><span class="p">,</span>
    <span class="n">VALUE_ERROR</span><span class="p">:</span> <span class="ne">ValueError</span><span class="p">,</span>
    <span class="n">INDEX_ERROR</span><span class="p">:</span> <span class="ne">IndexError</span><span class="p">,</span>
    <span class="n">RUNTIME_ERROR</span><span class="p">:</span> <span class="ne">RuntimeError</span><span class="p">,</span>
<span class="p">}</span>

<span class="c"># base.py</span>
<span class="kn">from</span> <span class="nn">.error</span> <span class="kn">import</span> <span class="n">ELEVATOR_ERROR</span>

<span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_uid</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">datas</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">Message</span><span class="p">(</span><span class="n">db_uid</span><span class="o">=</span><span class="n">db_uid</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">datas</span><span class="p">)])</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">FAILURE_STATUS</span><span class="p">:</span>
            <span class="n">error_code</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">raise</span> <span class="n">ELEVATOR_ERROR</span><span class="p">[</span><span class="n">error_code</span><span class="p">](</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">content</span>
</pre></div>

<h4>Response status</h4>

<p>Server responses ships with a status code to indicate whether the command was correctly executed or failed.
Here's their definition.</p>

<div class="highlight"><pre><span class="c"># Status codes</span>
<span class="n">SUCCESS_STATUS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">FAILURE_STATUS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>

<h3>Thanks</h3>

<p>Thanks to srinikom for its leveldb-server which was a very good base to start from. Thanks to Google, for its amazing database. Thanks to ZeroMQ team, you changed my life!</p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>