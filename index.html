<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Elevator by oleiade</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/oleiade/Elevator">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/oleiade/Elevator/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/oleiade/Elevator/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Elevator</h1>
          <p>Key-Value store written in Python and based on levelDB, allows high performance on-disk bulk read/write.</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/oleiade">oleiade</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></span>
        </div>

        <h1>Elevator</h1>

<h2>About</h2>

<p>Key-Value store written in Python and based on levelDB, allows high performance on-disk bulk read/write.
Allows async, remote acces to a multithreaded leveldb backend. Handles multiple concurrent database access and storage. Elevator tries to sublimate leveldb amazing features (disk persistent fast writes/reads, batching system, atomic updates[...]) by plugging it into a transparent rpc-ish service.</p>

<p>Relies on the zeromq network library and msgpack serialization format, it is made to be portable between languages and platforms. See <em>message system</em></p>

<h2>Dependencies</h2>

<div class="highlight"><pre>pyzmq
leveldb
snappy
py-leveldb
</pre></div>

<h2>Installation</h2>

<div class="highlight"><pre>pip install fabric
fab build
python setup.py install
</pre></div>

<h2>Server</h2>

<h3>Usage</h3>

<p>When elevator is installed, you can then launch the server using the elevator executable. Note that a --daemon option is disposable, and allows you to run elevator server as a daemon, storing it's pid in .pid file in /tmp.</p>

<p>See config/elevator.conf for an example of Elevator configuration.</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre>elevator --help
usage: elevator <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>--daemon<span class="o">]</span> <span class="o">[</span>--config<span class="o">]</span> <span class="o">[</span>--bind<span class="o">]</span> <span class="o">[</span>--port<span class="o">]</span>
                <span class="o">[</span>--workers<span class="o">]</span> <span class="o">[</span>--paranoid<span class="o">]</span>

Elevator <span class="nb">command </span>line manager

optional arguments:
  -h, --help       show this <span class="nb">help </span>message and <span class="nb">exit</span>
  --daemon
  --config      Path to elevator server config file
  --bind        Ip to <span class="nb">bind </span>server to, default is localhost
  --port        Port the server should listen on, default is 4141
  --workers     How many workers should be spawned? default is 4
  --paranoid    Should it <span class="nb">exit </span>on unhandled exceptions, default is <span class="nb">false</span>
</pre></div>

<h3>Configuration</h3>

<p>Server configuration relies on a INI file you can pass it as --config argument. All the configuration options key/value are then loaded in a server specific singleton Environment object, which any part of the server can eventually access.</p>

<p><strong>example config</strong> (<em>config/elevator.conf</em>)</p>

<div class="highlight"><pre><span class="k">[global]</span>
<span class="c"># By default Elevator does not run as a daemon. Use 'yes' if you need it.</span>
<span class="c"># Note that Elevator will write a pid file in /var/run/elevator.pid when daemonized.</span>
<span class="na">daemonize</span> <span class="o">=</span> <span class="s">no</span>

<span class="c"># When running daemonized, Elevator writes a pid file in /var/run/elevator.pid by</span>
<span class="c"># default. You can specify a custom pid file location here.</span>
<span class="na">pidfile</span> <span class="o">=</span> <span class="s">/var/run/elevator.pid</span>

<span class="c"># Where databases files should be store on the filesystem.</span>
<span class="na">databases_storage_path</span> <span class="o">=</span> <span class="s">/var/lib/elevator</span>

<span class="c"># Where should the file describing the databases store be</span>
<span class="c"># put on file system</span>
<span class="na">database_store</span> <span class="o">=</span> <span class="s">/var/lib/elevator/store.json</span>

<span class="c">#Default database</span>
<span class="na">default_db</span> <span class="o">=</span> <span class="s">default</span>

<span class="c"># Accept connections on the specified port, default is 4141.</span>
<span class="c"># If port 0 is specified Elevator will not listen on a TCP socket.</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">4141</span>

<span class="c"># If you want you can bind a single interface, if the bind option is not</span>
<span class="c"># specified all the interfaces will listen for incoming connections.</span>
<span class="c">#</span>
<span class="na">bind</span> <span class="o">=</span> <span class="s">127.0.0.1</span>

<span class="c"># Path to file were server activity should be logged</span>
<span class="na">activity_log</span> <span class="o">=</span> <span class="s">/var/log/elevator.log</span>

<span class="c"># Path to file were server warnings, errors, exceptions should be logged</span>
<span class="na">errors_log</span> <span class="o">=</span> <span class="s">/var/log/elevator_errors.log</span>

<span class="c"># Max global leveldb backends cache size in Mo. Note that each spawned leveldb</span>
<span class="c"># backend by default has a max_cache_size. This LRU cache is used to preload</span>
<span class="c"># in memory key that you have already fetch and accelerate random GET.</span>
<span class="c"># In order not to overflow the memory, max_cache_size ensures every backends</span>
<span class="c"># cache size cumulated does not exceed the provided value.</span>
<span class="na">max_cache_size</span> <span class="o">=</span> <span class="s">1024</span>

<span class="c"># Specify the path for the unix socket that will be used to listen for</span>
<span class="c"># incoming connections. There is no default, so Elevator will not listen</span>
<span class="c"># on a unix socket when not specified.</span>
<span class="c">#</span>
<span class="c"># unixsocket = /tmp/elevator.sock</span>
</pre></div>

<h3>Messages</h3>

<p>Typically, Server and client communicates via a <code>tcp://</code> socket handled by zeromq network library. Server spawns worker (threads) which it communicates with using an <code>inproc://</code> method. Every messages passed between client and server, or server and it's workers are serialized using <strong>msgpack</strong>.</p>

<p>As Elevator uses <strong>XREP</strong> and <strong>XREQ</strong> sockets, every commands passed through sockets are signed with a client id prefixing every sent datas. Queues messages in order to prevent overload.</p>

<p>In order to handle future features, like compression and chunking over huge packs of datas. Server socket is set to send <strong>multipart</strong> messages.</p>

<h4>Client -&gt; Server messaging format (<strong>Request</strong>)</h4>

<div class="highlight"><pre><span class="p">[</span>
    <span class="s">"DB_UID"</span> <span class="p">:</span> <span class="s">"Md5 hash of the database name you're working on"</span>
    <span class="s">"COMMAND"</span> <span class="p">:</span> <span class="n">PUT</span><span class="o">|</span><span class="n">GET</span><span class="o">|</span><span class="n">DELETE</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
    <span class="s">"ARGS"</span> <span class="p">:</span> <span class="p">[</span> <span class="s">"command arguments list"</span> <span class="p">]</span>
<span class="p">]</span>
</pre></div>

<h4>Server -&gt; Client messaging format (Response)</h4>

<p><strong>If the command succeeded</strong></p>

<div class="highlight"><pre><span class="p">{</span>
    <span class="s">"STATUS"</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">"DATAS"</span> <span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">],</span>
<span class="p">]</span>
</pre></div>

<p><strong>If the command failed</strong></p>

<div class="highlight"><pre><span class="p">{</span>
    <span class="s">"STATUS"</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s">"DATAS"</span><span class="p">:</span> <span class="p">[</span><span class="s">"ERROR_CODE"</span><span class="p">,</span> <span class="s">"error message"</span><span class="p">],</span>
<span class="p">]</span>
</pre></div>

<h4>Example</h4>

<p><strong>Request</strong></p>

<p>Requesting to put 'key'/'value' pair.</p>

<div class="highlight"><pre><span class="p">{</span>
    <span class="s">"DB_UID"</span><span class="p">:</span> <span class="s">"theamazingdatabasewewannaupdatemd5hash"</span><span class="p">,</span>
    <span class="s">"COMMAND"</span><span class="p">:</span> <span class="s">"PUT"</span><span class="p">,</span>
    <span class="s">"ARGS"</span><span class="p">:</span> <span class="p">[</span><span class="s">"key"</span><span class="p">,</span> <span class="s">"value"</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>

<p><em>would return</em></p>

<p><strong>Successful (and proud) Response</strong></p>

<p>Value has been succesfully added, server responds everything went fine with the SUCCESS_STATUS, and null as return value.</p>

<div class="highlight"><pre><span class="p">{</span>
    <span class="s">"STATUS"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">"DATAS"</span><span class="p">:</span> <span class="n">null</span>
<span class="p">}</span>
</pre></div>

<p><strong>Failure (and sheepish)</strong></p>

<p>Let's say you tried to put an int into Elevator (which he can't as it only handles strings). Note that ERROR_CODE value is 2, which represents a VALUE_ERROR, see <strong>Error types codes</strong></p>

<div class="highlight"><pre><span class="p">{</span>
    <span class="nt">"STATUS"</span><span class="p">:</span> <span class="mi">-1</span><span class="p">,</span>
    <span class="nt">"DATAS"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"2"</span><span class="p">,</span> <span class="s2">"Invalid value type supplied"</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>

<h3>Constants</h3>

<h4>Commands</h4>

<p>Server responds to some constants whenever it comes to give it commands. In the following listing, dbuid represents the database unique uid to operate the command over, it can be retrieved from a database name via 'CONNECT'. And batch_uid represents a valid server-side created batch (using BCREATE) to run commands over.</p>

<div class="highlight"><pre><span class="n">GET</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c"># Gets a value from a db</span>
<span class="n">MGET</span><span class="p">,</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>  <span class="c"># Mass transactional Get (frozen db state reads)</span>
<span class="n">PUT</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="c"># Insert a value in a db</span>
<span class="n">DELETE</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c"># Delete a value from a db</span>
<span class="n">RANGE</span><span class="p">,</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">limit</span><span class="p">]</span>  <span class="c"># Retrieve a range of key/value pair from a db</span>

<span class="n">BATCH</span><span class="p">,</span> <span class="p">[</span><span class="n">operations</span><span class="p">]</span>  <span class="c"># Atomically applies all batch operations server-side</span>

<span class="n">DBCONNECT</span> <span class="p">[</span><span class="n">db_name</span><span class="p">]</span>  <span class="c"># Connects a db via retrieving it's server-side uid</span>
<span class="n">DBCREATE</span> <span class="p">[</span><span class="n">db_name</span><span class="p">,</span> <span class="n">db_options</span><span class="p">]</span>  <span class="c"># Creates a db, with db_options</span>
<span class="n">DBLIST</span><span class="p">,</span> <span class="p">[]</span>  <span class="c"># Lists all server's dbs</span>
<span class="n">DBREPAIR</span><span class="p">,</span> <span class="p">[]</span>  <span class="c"># Repairs a broken (or too slow) database you already owns uid</span>
</pre></div>

<h5>About batches</h5>

<p>operations are treated server-side as signal. Batches exposes two signals:</p>

<div class="highlight"><pre><span class="n">BATCH_SIGNAL_PUT</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">BATCH_SIGNAL_DELETE</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>

<p>operations should be a list of lists composed following this pattern:</p>

<div class="highlight"><pre><span class="p">[</span><span class="n">BATCH_OPERATION_SIGNAL</span><span class="p">,</span> <span class="s">'key'</span><span class="p">,</span> <span class="s">'value if needed (Put)]</span>
</pre></div>

<h5>About db creation options</h5>

<p>Leveldb offers nice options when it comes to configure the backend storage and caching behavior. They should be passed in the msgpack message supplied to server on db creation as a hash. Only values set by yourself will override default values. Here is a description offered by py-leveldb of the available options.</p>

<div class="highlight"><pre><span class="n">create_if_missing</span>  <span class="c">#(default: True)           if True, creates a new database if none exists</span>
<span class="n">error_if_exists</span>    <span class="c">#(default: False)          if True, raises and error if the database already exists</span>
<span class="n">paranoid_checks</span>    <span class="c">#(default: False)          if True, raises an error as soon as an internal corruption is detected</span>
<span class="n">block_cache_size</span>   <span class="c">#(default: 8 * (2 &lt;&lt; 20))  maximum allowed size for the block cache in bytes</span>
<span class="n">write_buffer_size</span>  <span class="c">#(default  2 * (2 &lt;&lt; 20))  </span>
<span class="n">block_size</span>         <span class="c">#(default: 4096)           unit of transfer for the block cache in bytes</span>
<span class="n">max_open_files</span><span class="p">:</span>    <span class="c">#(default: 1000)</span>
</pre></div>

<h4>Error types codes</h4>

<p>All defined in elevator/constants.py module, they're used to bind an Elevator error type (python) to a language exception type.</p>

<div class="highlight"><pre><span class="n">TYPE_ERROR</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">KEY_ERROR</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">VALUE_ERROR</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">INDEX_ERROR</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">RUNTIME_ERROR</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">OS_ERROR</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">DATABASE_ERROR</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">SIGNAL_ERROR</span> <span class="o">=</span> <span class="mi">7</span>
</pre></div>

<p><em>Here's how the integrated python client deals with error codes</em></p>

<div class="highlight"><pre><span class="c"># error.py</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">elevator.constants</span> <span class="kn">import</span> <span class="o">*</span>


<span class="n">ELEVATOR_ERROR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">TYPE_ERROR</span><span class="p">:</span> <span class="ne">TypeError</span><span class="p">,</span>
    <span class="n">KEY_ERROR</span><span class="p">:</span> <span class="ne">KeyError</span><span class="p">,</span>
    <span class="n">VALUE_ERROR</span><span class="p">:</span> <span class="ne">ValueError</span><span class="p">,</span>
    <span class="n">INDEX_ERROR</span><span class="p">:</span> <span class="ne">IndexError</span><span class="p">,</span>
    <span class="n">RUNTIME_ERROR</span><span class="p">:</span> <span class="ne">RuntimeError</span><span class="p">,</span>
    <span class="n">OS_ERROR</span><span class="p">:</span> <span class="ne">OSError</span><span class="p">,</span>
    <span class="n">DATABASE_ERROR</span><span class="p">:</span> <span class="n">DatabaseError</span><span class="p">,</span>
    <span class="n">SIGNAL_ERROR</span><span class="p">:</span> <span class="n">SignalError</span><span class="p">,</span>
<span class="p">}</span>

<span class="c"># base.py</span>
<span class="kn">from</span> <span class="nn">.error</span> <span class="kn">import</span> <span class="n">ELEVATOR_ERROR</span>

<span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_uid</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">datas</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">Message</span><span class="p">(</span><span class="n">db_uid</span><span class="o">=</span><span class="n">db_uid</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">datas</span><span class="p">)])</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">FAILURE_STATUS</span><span class="p">:</span>
            <span class="n">error_code</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">raise</span> <span class="n">ELEVATOR_ERROR</span><span class="p">[</span><span class="n">error_code</span><span class="p">](</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">content</span>
</pre></div>

<h4>Response status</h4>

<p>Server responses ships with a status code to indicate whether the command was correctly executed or failed.
Here's their definition.</p>

<div class="highlight"><pre><span class="c"># Status codes</span>
<span class="n">SUCCESS_STATUS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">FAILURE_STATUS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">WARNING_STATUS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>  <span class="c"># Indicates the command succeded partially</span>
</pre></div>

<h3>Thanks</h3>

<p>Thanks to srinikom for its leveldb-server which was a very good base to start from.</p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>